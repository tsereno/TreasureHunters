<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Adventure Chatbot with Image Interaction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #user-input {
            width: calc(100% - 70px);
            padding: 5px;
        }
        #send-button {
            width: 60px;
            padding: 5px;
        }
        .message {
            margin-bottom: 10px;
        }
        .user-message {
            text-align: right;
            color: blue;
        }
        .ai-message {
            text-align: left;
            color: green;
        }
        #container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-top: 20px;
        }
        #webcam {
            width: 100%;
            max-width: 640px;
            margin-top: 20px;
        }
        #backpack {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>AI Adventure Chatbot with Image Interaction</h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-button">Send</button>

    <h2>Image Capture</h2>
    <button id="startWebcam">Start Webcam</button>
    <button id="captureImage">Capture Image</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="container"></div>

    <div id="backpack">
        <h3>Backpack</h3>
        <ul id="backpack-items"></ul>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"

        // Chatbot setup
        const genAI = new GoogleGenerativeAI('AIzaSyB3lEhfhLyO35g1iHJrzESYRFugs7mZPhc');
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro"});

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const backpackItems = document.getElementById('backpack-items');

        let chatHistory = [];
        let capturedImageBase64 = null;
        let backpack = [];

        async function generateContent(prompt, imageBase64) {
            try {
                let parts = [prompt];
                if (imageBase64) {
                    parts.unshift({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }
                const result = await model.generateContent(parts);
                return result.response.text();
            } catch (error) {
                console.error("Error generating content:", error);
                return "Sorry, I encountered an error. Please try again.";
            }
        }

        function addMessageToChat(message, isUser) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleUserInput() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessageToChat(userMessage, true);
                userInput.value = '';

                let prompt = `
                    You are an AI running a choose-your-own-adventure story. The user's backpack contains: ${backpack.join(', ')}.
                    
                    Previous conversation:
                    ${chatHistory.map(msg => `${msg.role}: ${msg.parts}`).join('\n')}
                    
                    User: ${userMessage}
                    
                    Respond to the user's input, continuing the story. If they want to use an item from their backpack, incorporate it into the story. If they want to add an item to their backpack, update the backpack contents.
                    
                    AI:`;

                if (capturedImageBase64) {
                    prompt = `Analyze the following image and incorporate it into our ongoing choose-your-own-adventure story. Describe the environment shown in the image, suggest objects or items the user could interact with or collect, and provide choices for the user's next action. Remember to keep the story context in mind.

                    ${prompt}`;
                }

                const aiResponse = await generateContent(prompt, capturedImageBase64);
                addMessageToChat(aiResponse, false);
                chatHistory.push({ role: "user", parts: userMessage });
                chatHistory.push({ role: "ai", parts: aiResponse });
                
                updateBackpack(aiResponse);
                capturedImageBase64 = null;
            }
        }

        function updateBackpack(aiResponse) {
            const addMatch = aiResponse.match(/added to (?:your|the) backpack: (.*?)(?:\.|$)/i);
            if (addMatch) {
                const newItem = addMatch[1].trim();
                if (!backpack.includes(newItem)) {
                    backpack.push(newItem);
                }
            }

            const removeMatch = aiResponse.match(/removed from (?:your|the) backpack: (.*?)(?:\.|$)/i);
            if (removeMatch) {
                const removedItem = removeMatch[1].trim();
                backpack = backpack.filter(item => item !== removedItem);
            }

            updateBackpackDisplay();
        }

        function updateBackpackDisplay() {
            backpackItems.innerHTML = '';
            backpack.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                backpackItems.appendChild(li);
            });
        }

        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        // Initial message
        generateContent("You are a choose your own adventure story. Introduce the story and give the user their first choice.").then(response => {
            addMessageToChat(response, false);
            chatHistory.push({ role: "ai", parts: response });
        });

        // Image Capture setup
        const startWebcamButton = document.getElementById('startWebcam');
        const captureImageButton = document.getElementById('captureImage');
        const webcamElement = document.getElementById('webcam');
        const imageContainer = document.getElementById('container');

        let stream;

        startWebcamButton.addEventListener('click', startWebcam);
        captureImageButton.addEventListener('click', captureImage);

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamElement.srcObject = stream;
                startWebcamButton.disabled = true;
                captureImageButton.disabled = false;
            } catch (err) {
                console.error("Error accessing the webcam:", err);
                alert('Error accessing the webcam');
            }
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = webcamElement.videoWidth;
            canvas.height = webcamElement.videoHeight;
            canvas.getContext('2d').drawImage(webcamElement, 0, 0);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            imageContainer.style.backgroundImage = `url(${imageDataUrl})`;
            capturedImageBase64 = imageDataUrl.split(',')[1];
            addMessageToChat("Image captured. The AI will analyze it in your next interaction.", false);
        }
    </script>
</body>
</html>
