<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Adventure Chatbot with Immediate Image Interaction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #user-input {
            width: calc(100% - 70px);
            padding: 5px;
        }
        #send-button {
            width: 60px;
            padding: 5px;
        }
        .message {
            margin-bottom: 10px;
        }
        .user-message {
            text-align: right;
            color: blue;
        }
        .ai-message {
            text-align: left;
            color: green;
        }
        #container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-top: 20px;
        }
        #webcam {
            width: 100%;
            max-width: 640px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>AI Adventure Chatbot with Immediate Image Interaction</h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-button">Send</button>

    <h2>Image Capture</h2>
    <button id="startWebcam">Start Webcam</button>
    <button id="captureImage">Capture Image</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="container"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"

        // Chatbot setup
        const genAI = new GoogleGenerativeAI('AIzaSyB3lEhfhLyO35g1iHJrzESYRFugs7mZPhc');
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest"});

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let chatHistory = [];
        let capturedImageBase64 = null;

        async function generateContent(prompt, imageBase64) {
            try {
                let parts = [prompt];
                if (imageBase64) {
                    parts.unshift({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }
                const result = await model.generateContent(parts);
                return result.response.text();
            } catch (error) {
                console.error("Error generating content:", error);
                return "Sorry, I encountered an error. Please try again.";
            }
        }

        function addMessageToChat(message, isUser) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleUserInput() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessageToChat(userMessage, true);
                userInput.value = '';

                let prompt = `
                    You are an AI running a scavenger hunt.
                    
                    Previous conversation:
                    ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}
                    
                    User: ${userMessage}
                    
                    Respond to the user's input, continuing the story.
                    
                    AI:`;

                const aiResponse = await generateContent(prompt);
                addMessageToChat(aiResponse, false);
                chatHistory.push({ role: "user", content: userMessage });
                chatHistory.push({ role: "ai", content: aiResponse });
            }
        }

        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        // Initial message
        generateContent("Your are an expert at analyzing an image.").then(response => {
            addMessageToChat(response, false);
            chatHistory.push({ role: "ai", content: response });
        });

        // Image Capture setup
        const startWebcamButton = document.getElementById('startWebcam');
        const captureImageButton = document.getElementById('captureImage');
        const webcamElement = document.getElementById('webcam');
        const imageContainer = document.getElementById('container');

        let stream;

        startWebcamButton.addEventListener('click', startWebcam);
        captureImageButton.addEventListener('click', captureImage);

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamElement.srcObject = stream;
                startWebcamButton.disabled = true;
                captureImageButton.disabled = false;
            } catch (err) {
                console.error("Error accessing the webcam:", err);
                alert('Error accessing the webcam');
            }
        }

        async function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = webcamElement.videoWidth;
            canvas.height = webcamElement.videoHeight;
            canvas.getContext('2d').drawImage(webcamElement, 0, 0);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            imageContainer.style.backgroundImage = `url(${imageDataUrl})`;
            capturedImageBase64 = imageDataUrl.split(',')[1];
            
            addMessageToChat("Image captured. Analyzing...", false);

            const imagePrompt = `

You are an advanced AI assistant designed to facilitate and manage an interactive smartphone-based scavenger hunt. Your primary functions are to interpret images captured by participants' smartphones, provide guidance, and maintain a comprehensive record of each participant's or team's progress. Your tasks include:

Analyze uploaded images to identify objects, locations, or completed tasks.
Generate and provide clues for the next location or task based on the current image.
Verify if participants have found the correct items or reached the intended locations.
Maintain an up-to-date list of completed tasks, found items, and overall progress for each participant or team. This list should be easily accessible and presentable upon request.
Use the progress list to ensure clues are given in the correct order and that participants don't receive duplicate tasks.
Offer hints or additional guidance if participants seem stuck, based on their submitted images and current progress.
Provide safety reminders and guidelines relevant to the locations shown in the images.
Suggest creative ways for participants to document their finds or complete tasks using their smartphone cameras.
Adapt difficulty levels based on the speed and accuracy of participants' image submissions and overall progress.
When responding to user inputs:

Always begin by analyzing any uploaded image and describing what you see in it.
Check the image against the participant's or team's current task list to confirm completion or provide guidance.
Update the progress list based on the submitted image and your analysis.
Provide a brief summary of the participant's or team's current progress (e.g., "You've completed 5 out of 10 tasks").
Relate your response directly to the content of the image and the current stage of the scavenger hunt.
Provide clear, concise instructions for the next step or task, ensuring it hasn't been completed already.
Maintain an encouraging and exciting tone to keep participants engaged.
If no image is provided, prompt the user to upload an image of their current location or latest find.
Remember to prioritize safety, inclusivity, and fun throughout the activity. Tailor your responses to the specific context of the hunt, considering factors such as indoor/outdoor settings, age groups, and any special themes or occasions.

For example, if a user uploads an image, you might respond like this:

"I see the image you've uploaded shows a large oak tree in a park setting. Excellent work! You've successfully completed task 3: 'Find the oldest tree in the park'.

Your current progress: 3 out of 10 tasks completed.

For your next challenge, task 4, look for a structure where children love to play. Take a photo when you find it, and I'll give you your next clue. Remember to stay safe and have fun!"

If a user asks for their progress, you could respond:

"Certainly! Here's your current progress in the scavenger hunt:

Find the red bench - Completed
Locate the flower garden - Completed
Find the oldest tree in the park - Completed
Photograph a playground structure - In Progress
5-10. Tasks not yet revealed
You've successfully completed 3 out of 10 tasks. Keep up the great work!"

            Previous conversation:
            ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

            AI:`;

            const aiResponse = await generateContent(imagePrompt, capturedImageBase64);
            addMessageToChat(aiResponse, false);
            chatHistory.push({ role: "ai", content: aiResponse });

            capturedImageBase64 = null;
        }
    </script>
</body>
</html>
