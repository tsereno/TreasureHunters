<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Adventure Chatbot with Image Classification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #user-input {
            width: calc(100% - 70px);
            padding: 5px;
        }
        #send-button {
            width: 60px;
            padding: 5px;
        }
        .message {
            margin-bottom: 10px;
        }
        .user-message {
            text-align: right;
            color: blue;
        }
        .ai-message {
            text-align: left;
            color: green;
        }
        #container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-top: 20px;
        }
        #results {
            margin-top: 20px;
        }
        .result-item {
            margin-bottom: 10px;
        }
        .label {
            font-weight: bold;
        }
        .score {
            color: #666;
        }
        #webcam {
            width: 100%;
            max-width: 640px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>AI Adventure Chatbot with Image Classification</h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-button">Send</button>

    <h2>Image Classification</h2>
    <p id="status">Loading model...</p>
    <button id="startWebcam">Start Webcam</button>
    <button id="captureImage">Capture Image</button>
    <button id="example">Run example</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="container"></div>
    <div id="results"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.10.1';

        // Chatbot setup
        const genAI = new GoogleGenerativeAI('AIzaSyB3lEhfhLyO35g1iHJrzESYRFugs7mZPhc');
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest"});

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let chatHistory = [];
        let capturedImageBase64 = null;

        async function generateContent(prompt, imageBase64) {
            try {
                let parts = [prompt];
                if (imageBase64) {
                    parts.unshift({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }
                const result = await model.generateContent(parts);
                return result.response.text();
            } catch (error) {
                console.error("Error generating content:", error);
                return "Sorry, I encountered an error. Please try again.";
            }
        }

        function addMessageToChat(message, isUser) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleUserInput() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessageToChat(userMessage, true);
                userInput.value = '';

                chatHistory.push({ role: "user", parts: userMessage });
                const fullPrompt = chatHistory.map(msg => `${msg.role}: ${msg.parts}`).join('\n') + "\nai:";

                const aiResponse = await generateContent(fullPrompt, capturedImageBase64);
                addMessageToChat(aiResponse, false);
                chatHistory.push({ role: "ai", parts: aiResponse });
                
                // Reset capturedImageBase64 after using it
                capturedImageBase64 = null;
            }
        }

        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        // Initial message
        generateContent("You are a choose your own adventure story. Introduce the story and give the user their first choice. If images are provided, describe the environment and available items that user can either interact with or collect into backpack to use later.").then(response => {
            addMessageToChat(response, false);
            chatHistory.push({ role: "ai", parts: response });
        });

        // Image Classification setup
        env.allowLocalModels = false;

        const status = document.getElementById('status');
        const startWebcamButton = document.getElementById('startWebcam');
        const captureImageButton = document.getElementById('captureImage');
        const webcamElement = document.getElementById('webcam');
        const imageContainer = document.getElementById('container');
        const example = document.getElementById('example');
        const resultsContainer = document.getElementById('results');

        const EXAMPLE_URL = 'https://huggingface.co/datasets/Xenova/transformers.js-docs/resolve/main/city-streets.jpg';

        let stream;
        let classifier;

        status.textContent = 'Loading model...';
        classifier = await pipeline('image-classification', 'Xenova/vit-base-patch16-224');
        
        status.textContent = 'Ready';

        startWebcamButton.addEventListener('click', startWebcam);
        captureImageButton.addEventListener('click', captureImage);

        example.addEventListener('click', (e) => {
            e.preventDefault();
            classify(EXAMPLE_URL);
        });

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamElement.srcObject = stream;
                startWebcamButton.disabled = true;
                captureImageButton.disabled = false;
            } catch (err) {
                console.error("Error accessing the webcam:", err);
                status.textContent = 'Error accessing the webcam';
            }
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = webcamElement.videoWidth;
            canvas.height = webcamElement.videoHeight;
            canvas.getContext('2d').drawImage(webcamElement, 0, 0);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            classify(imageDataUrl);
            capturedImageBase64 = imageDataUrl.split(',')[1]; // Store the base64 string
        }

        async function classify(img) {
            imageContainer.innerHTML = '';
            imageContainer.style.backgroundImage = `url(${img})`;
            resultsContainer.innerHTML = '';

            status.textContent = 'Classifying...';
            const output = await classifier(img, { topk: 5 });
            status.textContent = '';
            
            output.forEach(renderResult);
        }

        function renderResult({ label, score }) {
            const resultElement = document.createElement('div');
            resultElement.className = 'result-item';
            resultElement.innerHTML = `
                <span class="label">${label}:</span>
                <span class="score">${(score * 100).toFixed(2)}%</span>
            `;
            resultsContainer.appendChild(resultElement);
        }
    </script>
</body>
</html>
