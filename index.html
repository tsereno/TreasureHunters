<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Adventure Chatbot with Immediate Image Interaction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #user-input {
            width: calc(100% - 70px);
            padding: 5px;
        }
        #send-button {
            width: 60px;
            padding: 5px;
        }
        .message {
            margin-bottom: 10px;
        }
        .user-message {
            text-align: right;
            color: blue;
        }
        .ai-message {
            text-align: left;
            color: green;
        }
        #container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-top: 20px;
        }
        #webcam {
            width: 100%;
            max-width: 640px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>AI Adventure Chatbot with Immediate Image Interaction</h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-button">Send</button>

    <h2>Image Capture</h2>
    <button id="startWebcam">Start Webcam</button>
    <button id="captureImage">Capture Image</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="container"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"

        // Chatbot setup
        const genAI = new GoogleGenerativeAI('AIzaSyB3lEhfhLyO35g1iHJrzESYRFugs7mZPhc');
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro-latest"});

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let chatHistory = [];
        let capturedImageBase64 = null;

        async function generateContent(prompt, imageBase64) {
            try {
                let parts = [prompt];
                if (imageBase64) {
                    parts.unshift({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }
                const result = await model.generateContent(parts);
                return result.response.text();
            } catch (error) {
                console.error("Error generating content:", error);
                return "Sorry, I encountered an error. Please try again.";
            }
        }

        function addMessageToChat(message, isUser) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleUserInput() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessageToChat(userMessage, true);
                userInput.value = '';

                let prompt = `
                    You are an AI running a choose-your-own-adventure story.
                    
                    Previous conversation:
                    ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}
                    
                    User: ${userMessage}
                    
                    Respond to the user's input, continuing the story.
                    
                    AI:`;

                const aiResponse = await generateContent(prompt);
                addMessageToChat(aiResponse, false);
                chatHistory.push({ role: "user", content: userMessage });
                chatHistory.push({ role: "ai", content: aiResponse });
            }
        }

        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        // Initial message
        generateContent("You are a choose your own adventure story. Introduce the story and give the user their first choice.").then(response => {
            addMessageToChat(response, false);
            chatHistory.push({ role: "ai", content: response });
        });

        // Image Capture setup
        const startWebcamButton = document.getElementById('startWebcam');
        const captureImageButton = document.getElementById('captureImage');
        const webcamElement = document.getElementById('webcam');
        const imageContainer = document.getElementById('container');

        let stream;

        startWebcamButton.addEventListener('click', startWebcam);
        captureImageButton.addEventListener('click', captureImage);

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamElement.srcObject = stream;
                startWebcamButton.disabled = true;
                captureImageButton.disabled = false;
            } catch (err) {
                console.error("Error accessing the webcam:", err);
                alert('Error accessing the webcam');
            }
        }

        async function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = webcamElement.videoWidth;
            canvas.height = webcamElement.videoHeight;
            canvas.getContext('2d').drawImage(webcamElement, 0, 0);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            imageContainer.style.backgroundImage = `url(${imageDataUrl})`;
            capturedImageBase64 = imageDataUrl.split(',')[1];
            
            addMessageToChat("Image captured. Analyzing...", false);

            const imagePrompt = `You are now an evolving story. Your task is to create an immersive, interactive story experience for the player. Follow these guidelines:
                    
                    Story and Choices:
                    Begin the story immediately, describing the initial scene and situation.
                    Adapt the story based on the player's choices, creating branching narratives.
                    Inventory Management:
                    The player has a backpack to store items.
                    Keep track of items added to or removed from the backpack.
                    Allow the player to check their inventory at any time by typing "inventory".
                    Items in the inventory can be used in the story when appropriate.
                    Image Interaction:
                    When the player uploads an image, immediately incorporate elements from that image into the story.
                    Describe objects, people, or scenes from the image as part of the game world.
                    Create puzzles, challenges, or story elements based on the image contents.
                    Commands:
                    Recognize and respond to these commands:
                    "inventory": List all items in the player's backpack.
                    "use [item]": Attempt to use a specific item from the inventory.
                    "examine [object]": Provide a detailed description of an object in the current scene.
                    "help": List available commands and game instructions.
                    Game State:
                    Keep track of the player's progress, including key decisions and acquired items.
                    Use this information to influence future story developments and available choices.
                    Engagement:
                    Use vivid descriptions to create an immersive atmosphere.
                    Incorporate puzzles, challenges, and unexpected twists to keep the player engaged.
                    Adjust the story's tone and complexity based on the player's choices and interactions.
                    Begin the game by welcoming the player and describing the initial scene. If an image is uploaded, immediately integrate its contents into the opening scenario. Wait for the player's command before continuing the story.

            Previous conversation:
            ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

            AI:`;

            const aiResponse = await generateContent(imagePrompt, capturedImageBase64);
            addMessageToChat(aiResponse, false);
            chatHistory.push({ role: "ai", content: aiResponse });

            capturedImageBase64 = null;
        }
    </script>
</body>
</html>
